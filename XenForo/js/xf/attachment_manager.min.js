var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(c,g,f){c instanceof String&&(c=String(c));for(var h=c.length,a=0;a<h;a++){var b=c[a];if(g.call(f,b,a,c))return{i:a,v:b}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(c,g,f){c!=Array.prototype&&c!=Object.prototype&&(c[g]=f.value)};
$jscomp.getGlobal=function(c){return"undefined"!=typeof window&&window===c?c:"undefined"!=typeof global&&null!=global?global:c};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(c,g,f,h){if(g){f=$jscomp.global;c=c.split(".");for(h=0;h<c.length-1;h++){var a=c[h];a in f||(f[a]={});f=f[a]}c=c[c.length-1];h=f[c];g=g(h);g!=h&&null!=g&&$jscomp.defineProperty(f,c,{configurable:!0,writable:!0,value:g})}};
$jscomp.polyfill("Array.prototype.find",function(c){return c?c:function(c,f){return $jscomp.findInternal(this,c,f).v}},"es6","es3");
!function(c,g,f,h){XF.AttachmentManager=XF.Element.newHandler({options:{uploadButton:".js-attachmentUpload",manageUrl:null,container:".js-attachmentUploads",filesContainer:".js-attachmentFiles",fileRow:".js-attachmentFile",insertMultiRow:".js-attachmentInsertMultiRow",insertRow:".js-attachmentInsert",selectToggleButton:".js-attachmentSelect",selectActionButton:".js-attachmentSelectAction",actionButton:".js-attachmentAction",uploadTemplate:".js-attachmentUploadTemplate",templateProgress:".js-attachmentProgress",
templateError:".js-attachmentError",templateThumb:".js-attachmentThumb",templateView:".js-attachmentView",allowDrop:!1,checkVideoSize:!0},$container:null,$filesContainer:null,template:null,$form:null,legacyMode:!1,supportsVideoAudioUploads:null,manageUrl:null,flow:null,fileMap:{},isUploading:!1,lastScroll:0,editor:null,init:function(){var a=this,b=this.options,d=this.$target;if(g.Flow){var c=navigator.userAgent,e=c.match(/Android ([0-9]+)/);if(e&&5>parseInt(e[1],10)&&(c=c.match(/Chrome\/([0-9]+)/),
!c||33>parseInt(c[1],10))){console.warn("Old Android WebView detected. Must fallback to basic uploader.");return}c=d.find(b.uploadButton);if(this.options.manageUrl)this.manageUrl=this.options.manageUrl;else{if(!c.length){console.error("No manage URL specified and no uploaders available.");return}e=c.first();this.manageUrl=e.data("upload-href")||e.attr("href")}this.$container=d.find(b.container);this.$filesContainer=d.find(b.filesContainer);if(this.$container.length)this.$container.on("click",b.actionButton,
XF.proxy(this,"actionButtonClick")).on("click","input:checkbox",XF.proxy(this,"checkboxClick")).on("click",b.selectToggleButton,XF.proxy(this,"selectToggleClick")).on("click",b.selectActionButton,XF.proxy(this,"selectActionClick"));else this.legacyMode=!0,this.$filesContainer.on("click",b.actionButton,XF.proxy(this,"actionButtonClick"));(this.template=d.find(b.uploadTemplate).html())||console.error("No attached file template found.");(b=this.setupFlow())?(this.flow=b,this.setupUploadButtons(c,b),
this.options.allowDrop&&b.assignDrop([d[0]]),setTimeout(function(){a.editor=XF.getEditorInContainer(a.$target,"[data-attachment-target=false]");a.editor||a.removeInsertButtons(a.$container);a.toggleInsertMultiRow()},50),this.$form=this.$target.closest("form"),this.$form.length&&(this.$form.on("ajax-submit:before",function(b,c){a.isUploading&&!confirm(XF.phrase("files_being_uploaded_are_you_sure"))&&(c.preventSubmit=!0)}),this.$form.on("attachment-manager:reset",XF.proxy(this,"resetAttachments")))):
console.error("No flow uploader support")}else console.error("flow.js must be loaded")},setupFlow:function(){var a=this.getFlowOptions(),b=new Flow(a),c=this;if(!b.support){if(!g.FustyFlow)return null;a.matchJSON=!0;b=new FustyFlow(a)}b.on("fileAdded",XF.proxy(this,"fileAdded"));b.on("filesSubmitted",function(){c.setUploading(!0);b.upload()});b.on("fileProgress",XF.proxy(this,"uploadProgress"));b.on("fileSuccess",XF.proxy(this,"uploadSuccess"));b.on("fileError",XF.proxy(this,"uploadError"));return b},
getFlowOptions:function(){return{target:this.manageUrl,allowDuplicateUploads:!0,fileParameterName:"upload",query:XF.proxy(this,"uploadQueryParams"),simultaneousUploads:1,testChunks:!1,progressCallbacksInterval:100,chunkSize:4294967296,readFileFn:function(a,b,c,k,e){var d="slice";a.file.slice?d="slice":a.file.mozSlice?d="mozSlice":a.file.webkitSlice&&(d="webkitSlice");k||(k="");e.readFinished(a.file[d](b,c,k))}}},setupUploadButtons:function(a,b){var d=this;a.each(function(){var a=c(this),e=a.data("accept")||
"",l=c('<span class="js-attachButton" />').insertAfter(a).append(a);"."==e&&(e="");a.click(function(a){a.preventDefault()});b.assignBrowse(l[0],!1,!1,{accept:e});if(null===d.supportsVideoAudioUploads){a=XF.config.allowedVideoExtensions;var f=XF.config.allowedAudioExtensions;e=e.split(",");for(var g in e){var h=e[g].substr(1);if(-1!==a.indexOf(h)||-1!==f.indexOf(h)){d.supportsVideoAudioUploads=!0;break}}}l=l.find("input[type=file]");l.attr("title",XF.htmlspecialchars(XF.phrase("attach")));l.css("overflow",
"hidden");l.css(XF.isRtl()?"right":"left",-1E3)})},fileAdded:function(a){var b=this.applyUploadTemplate({filename:a.name,uploading:!0});this.resizeProgress(b,0);b.data("file",a);this.legacyMode?this.$filesContainer.addClass("is-active"):this.$container.addClass("is-active");b.appendTo(this.$filesContainer);this.fileMap[a.uniqueIdentifier]=b;var c=this.$filesContainer.closest('[data-xf-init="h-scroller"]');if(c.length&&(c=XF.Element.getHandler(c,"h-scroller"))){var k=Date.now();this.lastScroll<k-500&&
(this.lastScroll=k,c.scrollTo(b.position().left-50))}this.$target.find(this.options.uploadButton).blur();b=this.$target.find(this.options.uploadButton).first().data("video-size");if(this.options.checkVideoSize&&this.supportsVideoAudioUploads&&this.isVideoOrAudio(a)&&0<b&&a.size>b)return this.uploadError(a,this.addErrorToJson({},XF.phrase("file_too_large_to_upload"))),!1;if(0<XF.config.uploadMaxFilesize&&a.size>XF.config.uploadMaxFilesize)return this.uploadError(a,this.addErrorToJson({},XF.phrase("uploaded_file_is_too_large_for_server_to_process"))),
!1},isVideoOrAudio:function(a){var b=a.name.split(".");a=XF.config.allowedVideoExtensions;var c=XF.config.allowedAudioExtensions;if(1===b.length||""===b[0]&&b.length)return!1;b=b.pop();return-1!==a.indexOf(b)||-1!==c.indexOf(b)},uploadProgress:function(a){var b=this.fileMap[a.uniqueIdentifier];b&&(this.setUploading(!0),this.resizeProgress(b,a.progress()))},resizeProgress:function(a,b){b=Math.floor(100*b);a=a.find(this.options.templateProgress);var d=a.find("i");d.length||(d=c("<i />"),a.html("&nbsp;").append(d));
d.text(b+"%").css("width",b+"%")},uploadSuccess:function(a,b,c){b=this.getObjectFromMessage(b);this.setUploading(!1);b.status&&"error"==b.status?this.uploadError(a,b,c):b.attachment?this.insertUploadedRow(b.attachment,this.fileMap[a.uniqueIdentifier]):(b=this.addErrorToJson(b),this.uploadError(a,b,c))},setUploading:function(a){a=a?!0:!1;a!==this.isUploading&&((this.isUploading=a)?this.$target.trigger("attachment-manager:upload-start"):this.$target.trigger("attachment-manager:upload-end"))},getObjectFromMessage:function(a){if(a instanceof
Object)return a;try{return c.parseJSON(a)}catch(b){return this.addErrorToJson({})}},addErrorToJson:function(a,b){a.status="error";a.errors=[null===b?XF.phrase("oops_we_ran_into_some_problems"):b];return a},insertUploadedRow:function(a,b){a=this.applyUploadTemplate(a);this.editor||this.removeInsertButtons(a);b?b.replaceWith(a):(this.legacyMode?this.$filesContainer.addClass("is-active"):this.$container.addClass("is-active"),a.appendTo(this.$filesContainer));XF.activate(a);XF.layoutChange();b=c.Event("attachment:row-inserted");
a.trigger(b,[a,this]);this.toggleInsertMultiRow()},uploadError:function(a,b,c){b=this.getObjectFromMessage(b);this.setUploading(!1);var d=this.fileMap[a.uniqueIdentifier];d&&b.errors?(d.find(this.options.templateProgress).remove(),d.find(this.options.templateError).text(b.errors[0]),d.addClass("is-uploadError"),delete this.fileMap[a.uniqueIdentifier],d.removeData("file")):(XF.defaultAjaxSuccessError(b,200,c.xhr),this.removeFileRow(d))},actionButtonClick:function(a){a.preventDefault();var b=c(a.currentTarget);
a=b.attr("data-action");var d=b.attr("data-type");b=b.closest(this.options.fileRow);switch(a){case "thumbnail":case "full":this.insertAttachment(b,a,d);break;case "delete":this.deleteAttachment(b,d);break;case "cancel":this.cancelUpload(b)}},checkboxClick:function(){var a=this.$filesContainer.find("input:checkbox").filter(":checked").length;c(this.options.selectActionButton).prop("disabled",a?!1:!0)},selectToggleClick:function(a){a.preventDefault();this.setSelectActionState(!this.$container.hasClass("is-selecting"));
c(a.currentTarget).blur()},setSelectActionState:function(a){var b=this.$container;b.hasClass("is-selecting")!==a&&(b.find(this.options.selectToggleButton).each(function(){var a=c(this),b=a.attr("data-toggle"),e=a.text();a.text(b).attr("data-toggle",e)}),b[a?"addClass":"removeClass"]("is-selecting"))},selectActionClick:function(a){a.preventDefault();var b=c(a.currentTarget).attr("data-action"),d=this.options.fileRow,k=this.options.actionButton,e=this.$filesContainer.find(d+" input[type=checkbox]:checked");
e.each(function(){c(this).closest(d).find(k).filter(function(){return c(this).attr("data-action")===b}).click();e.prop("checked",!1)});this.$container.find(this.options.insertMultiRow).find('input[data-xf-init="check-all"]').prop("checked",!1);this.setSelectActionState(!1)},insertAttachment:function(a,b,c){c=c||"image";var d=a.data("attachment-id");if(d&&this.editor){var e=a.find(this.options.templateThumb).attr("src");a=a.find(this.options.templateView).attr("href");var f,g={id:d,img:e};if("full"==
b)b="[ATTACH=full]"+d+"[/ATTACH]","image"==c?f='<img src="{{img}}" data-attachment="full:{{id}}" alt="" />':"video"==c?f='<span contenteditable="false" draggable="true" class="fr-video fr-dvi fr-draggable fr-deletable"><video data-xf-init="video-init" data-attachment="full:{{id}}" src="{{img}}" controls></video></span>':"audio"==c&&(f='<span contenteditable="false" draggable="true" class="fr-audio fr-dvi fr-draggable fr-deletable"><audio data-attachment="full:{{id}}" src="{{img}}" controls></audio></span>'),
g.img=a;else{if(!e||"image"!==c)return;b="[ATTACH]"+d+"[/ATTACH]";f='<img src="{{img}}" data-attachment="thumb:{{id}}" alt="" />'}f=Mustache.render(f,g);XF.insertIntoEditor(this.$target,f,b,"[data-attachment-target=false]")}},deleteAttachment:function(a,b){b=b||"image";var d=a.data("attachment-id");if(d){var f=this;XF.ajax("post",this.manageUrl,{delete:d},function(b){b.delete&&f.removeFileRow(a)},{skipDefaultSuccess:!0});var e=new RegExp("^[a-z]+:"+d+"$","i"),g=new RegExp("\\[attach[^\\]]*\\]"+d+
"\\[/attach\\]","gi");XF.modifyEditorContent(this.$target,function(a){var d=a.ed;"image"==b||"file"==b?d.$el.find("img[data-attachment]").filter(function(){return e.test(c(this).attr("data-attachment"))}).each(function(){d.image.remove(c(this))}):("video"==b||"audio"==b)&&d.$el.find(b+"[data-attachment]").filter(function(){return e.test(c(this).attr("data-attachment"))}).each(function(){c(this).parent().remove()})},function(a){var b=a.val();b=b.replace(g,"");a.val(b)},"[data-attachment-target=false]")}},
cancelUpload:function(a){var b=a.data("file");a.data("attachment-id")||b&&1==b.progress()||(this.flow.removeFile(b),this.flow.isUploading()||this.setUploading(!1),this.removeFileRow(a))},uploadQueryParams:function(){return{_xfToken:XF.config.csrf,_xfResponseType:"json",_xfWithData:1}},applyUploadTemplate:function(a){a=c(c.parseHTML(Mustache.render(this.template,a)));var b=this.options.fileRow;return a.filter(function(){return c(this).is(b)})},removeFileRow:function(a){a.remove();this.toggleInsertMultiRow();
this.getFileRows().length||(this.legacyMode?this.$filesContainer.removeClass("is-active"):this.$container.removeClass("is-active"),XF.layoutChange())},removeInsertButtons:function(a){a.find(this.options.insertRow+","+this.options.insertMultiRow).remove();XF.layoutChange()},toggleInsertMultiRow:function(){this.checkboxClick();var a=this.$filesContainer.find(this.options.actionButton).filter(":not([data-action=delete])").closest(this.options.fileRow),b=this.$container.find(this.options.insertMultiRow);
1<a.length?b.addClass("is-active"):b.removeClass("is-active");XF.layoutChange()},resetAttachments:function(){var a=this;a.getFileRows().each(function(){a.removeFileRow(c(this))})},getFileRows:function(){return this.$filesContainer.find(this.options.fileRow)}});XF.AttachmentOnInsert=XF.Element.newHandler({options:{fileRow:".js-attachmentFile",href:null,linkData:null},loading:!1,init:function(){var a=this.$target.closest(this.options.fileRow);a.length&&this.options.href||console.error("Cannot find inserted row or action to perform.");
a.on("attachment:row-inserted",XF.proxy(this,"onAttachmentInsert"))},onAttachmentInsert:function(a,b,c){if(!this.loading){var d=this;XF.ajax("post",this.options.href,this.options.linkData||{},XF.proxy(this,"onLoad")).always(function(){d.loading=!1})}},onLoad:function(a){if(a.html){var b=this;XF.setupHtmlInsert(a.html,function(a,c,e){b.$target.replaceWith(a).xfFadeDown(XF.config.speed.xfast,function(){e(!0);XF.layoutChange()})})}}});XF.Element.register("attachment-manager","XF.AttachmentManager");
XF.Element.register("attachment-on-insert","XF.AttachmentOnInsert")}(jQuery,window,document);
